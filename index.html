<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø³ÙƒÙŠÙ†Ø© - ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø£Ø´Ø®Ø§Øµ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage-green: #7ca982;
            --dusty-rose: #d4a5a5;
            --cream-bg: #f8f9f5;
            --dark-olive: #3d5a44;
            --white: #ffffff;
            --light-blue: #a5c8d4;
            --purple: #b4a5d4;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--cream-bg);
            margin: 0; padding: 0;
            color: var(--dark-olive);
            height: 100vh; overflow: hidden;
            direction: rtl;
        }
        .target-achieved-msg {
    animation: pulse Green 2s infinite;
    box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2);
}

@keyframes pulseGreen {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            background: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 0 0 25px 25px;
        }
        
        .modal-input {
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            border-radius: 10px; 
            border: 1px solid #ddd;
            font-family: 'Tajawal', sans-serif;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .content-area { 
            height: calc(100vh - 260px); 
            overflow-y: auto; 
            padding: 20px; 
        }
        
        .page { 
            display: none; 
        }
        
        .page.active { 
            display: block; 
            animation: fadeIn 0.3s; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }

        /* Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¶Ø®Ù… */
        .praise-section { 
            text-align: center; 
            padding-top: 30px; 
        }
        
        .counter-btn {
            width: 250px; 
            height: 250px; 
            border-radius: 50%;
            background: var(--white); 
            border: 12px solid var(--sage-green);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            transition: 0.1s; 
            margin-bottom: 25px;
        }
        
        .counter-btn:active { 
            transform: scale(0.95); 
            border-color: var(--dusty-rose); 
        }
        
        .counter-btn .number { 
            font-size: 60px; 
            font-weight: bold; 
            color: var(--sage-green); 
        }
        /* Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙÙŠ Ù‚Ø³Ù… style */
.active-person-badge {
    background: linear-gradient(135deg, var(--light-blue), #8bb8d4);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-size: 0.95em;
    margin-bottom: 15px;
    display: inline-block;
    box-shadow: 0 4px 12px rgba(125, 169, 130, 0.2);
    animation: slideDown 0.3s ease;
    direction: rtl;
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 300px;
    margin: 0 auto 20px auto;
}

.active-person-badge i {
    margin-left: 8px;
}

@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
#campaignsTab{
    margin-bottom: 15svh;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
.counter-btn.active-person {
    border-color: var(--light-blue) !important;
    box-shadow: 0 10px 30px rgba(165, 200, 212, 0.3);
}

.counter-btn.active-campaign {
    border-color: var(--sage-green) !important;
    box-shadow: 0 10px 30px rgba(124, 169, 130, 0.3);
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· */
.counter-btn.active-person:active {
    border-color: var(--dusty-rose) !important;
}
        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card { 
            background: white; 
            border-radius: 15px; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-right: 5px solid var(--dusty-rose); 
        }
        
        .person-card {
            border-right: 5px solid var(--light-blue);
        }
        
        .campaign-card {
            border-right: 5px solid var(--dusty-rose);
        }
        
        .progress-bar { 
            height: 8px; 
            background: #eee; 
            border-radius: 4px; 
            margin: 10px 0; 
            overflow: hidden; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: var(--sage-green); 
            transition: 0.5s; 
        }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            align-items: flex-end; 
            z-index: 1000; 
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content { 
            background: white; 
            width: 100%; 
            border-radius: 25px 25px 0 0; 
            padding: 25px; 
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            height: 70px; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            border-top: 1px solid #eee; 
        }
        
        .nav-item { 
            border: none; 
            background: none; 
            color: #aaa; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-family: inherit; 
        }
        
        .nav-item.active { 
            color: var(--sage-green); 
            font-weight: bold; 
        }

        .btn-action { 
            background: var(--sage-green); 
            color: white; 
            border: none; 
            padding: 12px; 
            width: 100%; 
            border-radius: 10px; 
            font-size: 18px; 
            margin-top: 10px; 
        }
        
        .btn-contribute {
            background: var(--light-blue);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            width: 100%;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 8px;
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .btn-pray-for {
            background: var(--purple);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 8px;
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .active-person-badge {
            background: var(--sage-green);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: inline-block;
        }
        
        .person-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .person-name {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--dark-olive);
        }
        
        .category-tag {
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-family: inherit;
            font-size: 1em;
            color: #999;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn.active {
            color: var(--sage-green);
            border-bottom: 3px solid var(--sage-green);
            font-weight: bold;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--sage-green);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .prayer-summary {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1 id="pageTitle">ØªØ³Ø¨ÙŠØ­</h1>
        <button onclick="openModal('settingsModal')" style="border:none; background:none; font-size:24px; color:var(--sage-green)">
            <i class="fas fa-cog"></i>
        </button>
    </header>

    <div class="content-area">
        <section id="praisePage" class="page active">
            <div id="activePersonBadge" class="active-person-badge" style="display:none;">
                <i class="fas fa-user"></i> Ø£Ù†Øª ØªØ³Ø¨Ø­ Ù„Ù€: <span id="activePersonName"></span>
            </div>
            
            <div class="praise-section">
                <div class="counter-btn" 
     onclick="doPraise(event)" 
     style="touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none;">
    <span id="mainCounter" class="number">0</span>
    <span style="color:#999">Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¨ÙŠØ­</span>
</div>
                
                <div class="prayer-summary">
                    <h3 style="margin-top:0;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ³Ø¨ÙŠØ­</h3>
                    <div style="display:flex; justify-content:space-around;">
                        <div>
                            <div style="font-size:1.5em; font-weight:bold; color:var(--sage-green);" id="totalPraise">0</div>
                            <div style="font-size:0.9em; color:#666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ³Ø¨ÙŠØ­Ø§ØªÙƒ</div>
                        </div>
                        <div>
                            <div style="font-size:1.5em; font-weight:bold; color:var(--light-blue);" id="todayPraise">0</div>
                            <div style="font-size:0.9em; color:#666;">ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn-action" style="background:var(--dusty-rose); width:80%" onclick="openModal('helpModal')">Ø·Ù„Ø¨ Ø§Ø³ØªØºØ§Ø«Ø© Ù…Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
            </div>
        </section>

        <section id="communityPage" class="page">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('campaignsTab', this)">Ø§Ù„Ø­Ù…Ù„Ø§Øª</button>
                <button class="tab-btn" onclick="switchTab('personsTab', this)">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</button>
            </div>
            
            <div id="campaignsTab" class="tab-content">
                <div id="campaignsContainer">
                    <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª...</p>
                </div>
            </div>
            
            <div id="personsTab" class="tab-content" style="display:none;">
                <div id="personsContainer">
                    <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ...</p>
                </div>
            </div>
        </section>
    </div>

    <button class="floating-btn" onclick="openModal('addPersonModal')">
        <i class="fas fa-user-plus"></i>
    </button>

    <nav class="bottom-nav">
        <button id="praiseBtn" class="nav-item active" onclick="switchPage('praisePage', 'ØªØ³Ø¨ÙŠØ­', this)">
            <i class="fas fa-fingerprint"></i><span>ØªØ³Ø¨ÙŠØ­</span>
        </button>
        <button class="nav-item" onclick="switchPage('communityPage', 'Ø§Ù„Ø­Ù…Ù„Ø§Øª', this)">
            <i class="fas fa-mosque"></i><span>Ø§Ù„Ø­Ù…Ù„Ø§Øª</span>
        </button>
    </nav>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯ -->
    <div id="addPersonModal" class="modal" onclick="closeOnOverlay(event)">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù‡</h3>
            <p style="font-size: 0.9em; color: #666;">Ø£Ø¶Ù Ø´Ø®ØµØ§Ù‹ Ù„ØªØ³Ø¨Ø­ Ù„Ù‡ ÙˆØªØ­ØµÙ‘Ù„ Ø§Ù„Ø£Ø¬Ø± Ø£Ù†Øª ÙˆÙ„Ù‡ Ù…Ø¹Ø§Ù‹.</p>
            
            <input type="text" id="personName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ (Ù…Ø«Ù„Ø§Ù‹: ÙˆØ§Ù„Ø¯ÙŠØŒ ØµØ¯ÙŠÙ‚ÙŠ Ø£Ø­Ù…Ø¯)" class="modal-input">
            <textarea id="personDesc" placeholder="ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="modal-input" style="height: 80px;"></textarea>
            
            <div style="display:flex; gap:10px;">
                <select id="personCategory" class="modal-input" style="flex:1;">
                    <option value="Ø¹Ø§Ø¦Ù„Ø©">Ø¹Ø§Ø¦Ù„Ø©</option>
                    <option value="Ø£ØµØ¯Ù‚Ø§Ø¡">Ø£ØµØ¯Ù‚Ø§Ø¡</option>
                    <option value="Ù…Ø±Ø¶Ù‰">Ù…Ø±Ø¶Ù‰</option>
                    <option value="Ø£Ù…ÙˆØ§Øª">Ø£Ù…ÙˆØ§Øª</option>
                    <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
                </select>
                
                <input type="number" id="personTarget" placeholder="Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¨ÙŠØ­" class="modal-input" style="flex:1;" value="1000">
            </div>
            
            <button class="btn-action" onclick="addNewPerson()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø®Øµ</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø© -->
    <div id="helpModal" class="modal" onclick="closeOnOverlay(event)">
        <div class="modal-content">
            <h3>Ø§Ù†Ø´Ø± Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø© Ø¨Ø§Ù„Ø°ÙƒØ±</h3>
            <p style="font-size: 0.9em; color: #666;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø£Ø¬Ø±.</p>
            
            <input type="text" id="helpTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ø³ØªØºÙØ§Ø± Ù„Ù„Ù…Ø·Ø±)" class="modal-input">
            <textarea id="helpDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ø¯Ø¹Ø§Ø¡..." class="modal-input" style="height: 80px;"></textarea>
            <input type="number" id="helpTarget" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ù…Ø«Ù„Ø§Ù‹: 1000)" class="modal-input">
            
            <button class="btn-action" onclick="broadcastHelp()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="settingsModal" class="modal" onclick="closeOnOverlay(event)">
        <div class="modal-content">
            <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <input type="text" id="userNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…" class="modal-input">
            
            <h4 style="margin-top:20px;">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h4>
            <div style="background:#f9f9f9; padding:15px; border-radius:10px;">
                <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ³Ø¨ÙŠØ­Ø§ØªÙƒ: <span id="statTotal" style="font-weight:bold;">0</span></div>
                <div>ØªØ³Ø¨ÙŠØ­Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: <span id="statWeek" style="font-weight:bold;">0</span></div>
                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† ØªØ³Ø¨Ø­ Ù„Ù‡Ù…: <span id="statPersons" style="font-weight:bold;">0</span></div>
                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªÙŠ Ø³Ø§Ù‡Ù…Øª ÙÙŠÙ‡Ø§: <span id="statCampaigns" style="font-weight:bold;">0</span></div>
            </div>
            
            <button class="btn-action" onclick="saveUserName()">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
            <button class="btn-action" style="background:#666; margin-top:10px;" onclick="clearAllData()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
        </div>
    </div>

    <script>
        // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        const BASE_URL = "http://doaa-one.vercel.app"; 
        const WS_URL = "wss://doaa-one.vercel.app/ws";

        let localCount = 0;
        let todayCount = 0;
        let totalCount = 0;
        let userId = localStorage.getItem('user_id') || Math.floor(Math.random() * 1000000);
        localStorage.setItem('user_id', userId);

        let socket;
        let activeCampaignId = null;
        let activePersonId = null;
        let offlineBuffer = 0;
        let persons = JSON.parse(localStorage.getItem('persons')) || [];

        function initWebSocket() {
    try {
        socket = new WebSocket(`${WS_URL}/ws/help`);

        socket.onopen = () => {
            console.log("Ù…ØªØµÙ„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø© Ø§Ù„Ø­ÙŠ");
            // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
            socket.send(JSON.stringify({
                type: "USER_CONNECTED",
                user_id: userId,
                user_name: localStorage.getItem('user_name') || "Ù…Ø³ØªØ®Ø¯Ù…"
            }));
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if(data.type === "HELP_REQUEST") {
                const currentUserName = localStorage.getItem('user_name');
                if(data.username !== currentUserName) {
                    if(confirm(`Ø£Ø®ÙˆÙ†Ø§ ${data.username} ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ${data.count} ØªØ³Ø¨ÙŠØ­Ø©. Ù‡Ù„ ØªØ¹ÙŠÙ†Ù‡ØŸ`)) {
                        alert("Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹ØŒ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ùƒ.");
                    }
                }
            }
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª
            if(data.type === "PRAYER_UPDATE") {
                updateCampaignCounter(data.prayer_id, data.new_count);
            }
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø©
            if(data.type === "PRAYER_COMPLETED") {
                if(confirm(`Ù…Ø¨Ø§Ø±Ùƒ! ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø© "${data.title}". Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŸ`)) {
                    loadCampaigns();
                }
            }
        };

        socket.onclose = () => {
            console.log("Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ WSØŒ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù...");
            setTimeout(initWebSocket, 3000);
        };
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ WebSocket:", e);
    }
}
// Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆÙ‚Ø¨Ù„ window.onload
function updateActiveDisplay() {
    console.log("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·...");
    
    const badge = document.getElementById('activePersonBadge');
    const counterBtn = document.querySelector('.counter-btn');
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù†Ø§ØµØ± DOM
    if (!badge) {
        console.warn("âš ï¸ Ø¹Ù†ØµØ± activePersonBadge ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        return;
    }
    
    if (!counterBtn) {
        console.warn("âš ï¸ Ø¹Ù†ØµØ± counterBtn ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    }
    
    // Ø­Ø§Ù„Ø© 1: Ù‡Ù†Ø§Ùƒ Ø´Ø®Øµ Ù†Ø´Ø·
    if (activePersonId) {
        console.log(`ğŸ‘¤ Ø´Ø®Øµ Ù†Ø´Ø·: ${activePersonId}`);
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
        const activePerson = persons.find(p => p.id === activePersonId);
        
        if (activePerson) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
            badge.style.display = 'block';
            const nameSpan = document.getElementById('activePersonName');
            if (nameSpan) {
                nameSpan.textContent = activePerson.name;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­
            counterBtn.style.borderColor = 'var(--light-blue)';
            
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            addCloseButtonToBadge();
            
            console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø´Ø®Øµ: ${activePerson.name}`);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø®ØµØŒ Ù‚Ù… Ø¨ØªÙ†Ø¸ÙŠÙ
            console.warn(`âš ï¸ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· ${activePersonId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©`);
            clearActivePerson();
        }
    }
    // Ø­Ø§Ù„Ø© 2: Ù‡Ù†Ø§Ùƒ Ø­Ù…Ù„Ø© Ù†Ø´Ø·Ø©
    else if (activeCampaignId) {
        console.log(`ğŸ¯ Ø­Ù…Ù„Ø© Ù†Ø´Ø·Ø©: ${activeCampaignId}`);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø´Ø®Øµ
        badge.style.display = 'none';
        
        // Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø­Ù…Ù„Ø§Øª
        counterBtn.style.borderColor = 'var(--sage-green)';
        
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø­Ù…Ù„Ø©`);
    }
    // Ø­Ø§Ù„Ø© 3: Ù„Ø§ Ø´ÙŠØ¡ Ù†Ø´Ø· (ØªØ³Ø¨ÙŠØ­ Ø¹Ø§Ù…)
    else {
        console.log("ğŸŒ ØªØ³Ø¨ÙŠØ­ Ø¹Ø§Ù…");
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø´Ø®Øµ
        badge.style.display = 'none';
        
        // Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…
        counterBtn.style.borderColor = 'var(--sage-green)';
        
        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…`);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ø¨Ø§Ø¯Ø¬
function addCloseButtonToBadge() {
    const badge = document.getElementById('activePersonBadge');
    if (!badge) return;
    
    // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
    if (badge.querySelector('.badge-close-btn')) return;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    const closeBtn = document.createElement('button');
    closeBtn.className = 'badge-close-btn';
    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
    closeBtn.style.cssText = `
        margin-right: 10px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        cursor: pointer;
        font-size: 0.9em;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    `;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ…
    closeBtn.onmouseover = () => {
        closeBtn.style.background = 'rgba(255,255,255,0.3)';
    };
    closeBtn.onmouseout = () => {
        closeBtn.style.background = 'rgba(255,255,255,0.2)';
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
    closeBtn.onclick = (e) => {
        e.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø«
        switchToGeneralPraise();
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ø¨Ø§Ø¯Ø¬
    badge.insertBefore(closeBtn, badge.firstChild);
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© switchToGeneralPraise
function switchToGeneralPraise() {
    console.log("ğŸ”„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…");
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
    if (activePersonId) {
        clearActivePerson();
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    if (activeCampaignId) {
        localStorage.removeItem('active_campaign');
        activeCampaignId = null;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateActiveDisplay();
    
    // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    showTemporaryAlert('Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ ØªØ³Ø¨ÙŠØ­Ø§Ù‹ Ø¹Ø§Ù…Ø§Ù‹', 'info');
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
    document.getElementById('pageTitle').innerText = 'ØªØ³Ø¨ÙŠØ­';
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© clearActivePerson
function clearActivePerson() {
    console.log(`ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·`);
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±
    activePersonId = null;
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† localStorage
    localStorage.removeItem('active_person');
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    if (persons && persons.length > 0) {
        loadPersons();
    }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© setActivePerson
function setActivePerson(id, name) {
    console.log(`ğŸ‘¤ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·: ${name} (${id})`);
    
    // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (activeCampaignId) {
        localStorage.removeItem('active_campaign');
        activeCampaignId = null;
    }
    
    // 2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
    activePersonId = id;
    
    // 3. Ø­ÙØ¸ ÙÙŠ localStorage
    localStorage.setItem('active_person', JSON.stringify({id, name}));
    
    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateActiveDisplay();
    
    // 5. ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    setTimeout(() => {
        loadPersons();
    }, 100);
    
    // 6. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª
    const communityPage = document.getElementById('communityPage');
    if (communityPage && communityPage.classList.contains('active')) {
        setTimeout(() => {
            switchPage('praisePage', `ØªØ³Ø¨ÙŠØ­ Ù„Ù€: ${name}`, document.getElementById('praiseBtn'));
        }, 200);
    }
    
    // 7. Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    setTimeout(() => {
        showTemporaryAlert(`Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ Ù„Ù€: ${name}`, 'success');
    }, 300);
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© startContributing
function startContributing(campaignId, campaignTitle) {
    console.log(`ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© ÙÙŠ Ø§Ù„Ø­Ù…Ù„Ø© ${campaignId}: ${campaignTitle}`);
    
    // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (activePersonId) {
        clearActivePerson();
    }
    
    // 2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    activeCampaignId = campaignId;
    
    // 3. Ø­ÙØ¸ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    localStorage.setItem('active_campaign', JSON.stringify({
        id: campaignId,
        title: campaignTitle
    }));
    
    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateActiveDisplay();
    
    // 5. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­
    setTimeout(() => {
        switchPage('praisePage', `Ù…Ø³Ø§Ù‡Ù…Ø© ÙÙŠ: ${campaignTitle}`, document.getElementById('praiseBtn'));
    }, 100);
    
    // 6. Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    setTimeout(() => {
        showTemporaryAlert(`Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ Ù„Ù€: ${campaignTitle}`, 'info');
    }, 200);
}
// =========== ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© updateActivePersonBadge ===========
function updateActivePersonBadge() {
    console.log("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·...");
    
    const badge = document.getElementById('activePersonBadge');
    if (!badge) {
        console.warn("âš ï¸ Ø¹Ù†ØµØ± activePersonBadge ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©");
        return;
    }
    
    // Ø­Ø§Ù„Ø© 1: Ù‡Ù†Ø§Ùƒ Ø´Ø®Øµ Ù†Ø´Ø·
    if (activePersonId) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
        const activePerson = persons.find(p => p.id === activePersonId);
        
        if (activePerson) {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
            badge.style.display = 'flex';
            const nameSpan = document.getElementById('activePersonName');
            if (nameSpan) {
                nameSpan.textContent = activePerson.name;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­
            const counterBtn = document.querySelector('.counter-btn');
            if (counterBtn) {
                counterBtn.style.borderColor = 'var(--light-blue)';
                counterBtn.classList.add('active-person');
                counterBtn.classList.remove('active-campaign');
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            addCloseButtonToBadge();
            
            console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø´Ø®Øµ: ${activePerson.name}`);
        } else {
            // Ø§Ù„Ø´Ø®Øµ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬
            badge.style.display = 'none';
            console.warn(`âš ï¸ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· ${activePersonId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
        }
    }
    // Ø­Ø§Ù„Ø© 2: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø®Øµ Ù†Ø´Ø·
    else {
        badge.style.display = 'none';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const counterBtn = document.querySelector('.counter-btn');
        if (counterBtn) {
            counterBtn.style.borderColor = 'var(--sage-green)';
            counterBtn.classList.remove('active-person', 'active-campaign');
        }
        
        console.log("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø®Øµ Ù†Ø´Ø·ØŒ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬");
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
function addCloseButtonToBadge() {
    const badge = document.getElementById('activePersonBadge');
    if (!badge) return;
    
    // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
    if (badge.querySelector('.badge-close-btn')) {
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    const closeBtn = document.createElement('button');
    closeBtn.className = 'badge-close-btn';
    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
    closeBtn.setAttribute('aria-label', 'Ø¥ØºÙ„Ø§Ù‚');
    closeBtn.title = 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…';
    
    // Ø£Ù†Ù…Ø§Ø· CSS
    closeBtn.style.cssText = `
        margin-left: 10px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        cursor: pointer;
        font-size: 0.9em;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        padding: 0;
        flex-shrink: 0;
    `;
    
    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ…
    closeBtn.onmouseenter = function() {
        this.style.background = 'rgba(255, 255, 255, 0.3)';
        this.style.transform = 'scale(1.1)';
    };
    
    closeBtn.onmouseleave = function() {
        this.style.background = 'rgba(255, 255, 255, 0.2)';
        this.style.transform = 'scale(1)';
    };
    
    // Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
    closeBtn.onclick = function(e) {
        e.stopPropagation();
        switchToGeneralPraise();
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ø¨Ø§Ø¯Ø¬
    badge.insertBefore(closeBtn, badge.firstChild);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…
function switchToGeneralPraise() {
    console.log("ğŸ”„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…");
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    activePersonId = null;
    activeCampaignId = null;
    
    // ØªÙ†Ø¸ÙŠÙ localStorage
    localStorage.removeItem('active_person');
    localStorage.removeItem('active_campaign');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
    updateActivePersonBadge();
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†ÙˆØ§ Ù…Ø±Ø¦ÙŠÙŠÙ†
    if (document.getElementById('personsTab')?.style.display !== 'none') {
        loadPersons();
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø±Ø¦ÙŠØ©
    if (document.getElementById('campaignsTab')?.style.display !== 'none') {
        loadCampaigns();
    }
    
    // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    showTemporaryAlert('Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ ØªØ³Ø¨ÙŠØ­Ø§Ù‹ Ø¹Ø§Ù…Ø§Ù‹', 'info');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    document.getElementById('pageTitle').textContent = 'ØªØ³Ø¨ÙŠØ­';
}

function loadLocalData() {
    console.log("ğŸ’¾ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...");
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    persons = JSON.parse(localStorage.getItem('persons')) || [];
    console.log(`ğŸ‘¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${persons.length} Ø´Ø®Øµ`);
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚
    try {
        const savedActivePerson = localStorage.getItem('active_person');
        if (savedActivePerson) {
            const personData = JSON.parse(savedActivePerson);
            activePersonId = personData.id;
            console.log(`ğŸ¯ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·: ${personData.name}`);
        }
    } catch (e) {
        console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·:", e);
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    try {
        const savedActiveCampaign = localStorage.getItem('active_campaign');
        if (savedActiveCampaign) {
            const campaignData = JSON.parse(savedActiveCampaign);
            activeCampaignId = campaignData.id;
            console.log(`ğŸ¯ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©: ${campaignData.title}`);
        }
    } catch (e) {
        console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©:", e);
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
}
        async function initializeLocalStats() {
    console.log("ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...");
    
    const today = new Date().toDateString();
    const weekStart = getWeekStartDate();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    let stats = JSON.parse(localStorage.getItem('praise_stats')) || {
        total: 0,
        today: 0,
        todayDate: today,
        week: 0,
        weekStart: weekStart,
        streaks: 0,
        lastPraiseDate: null,
        sessionCount: 0 // <-- Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©
    };
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ…
    if (stats.todayDate !== today) {
        console.log("ğŸ“… ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…");
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙŠÙˆÙ…
        stats.today = 0;
        stats.todayDate = today;
        
        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ sessionCount Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        // Ù„Ø§ Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ†Ù‡ Ù„Ø£Ù†Ù‡ Ø®Ø§Øµ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
    }
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
    if (stats.weekStart !== weekStart) {
        console.log("ğŸ“† Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹");
        stats.week = 0;
        stats.weekStart = weekStart;
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© - ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§
    totalCount = stats.total || 0;
    todayCount = stats.today || 0;
    localCount = stats.sessionCount || 0; // <-- Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©
    
    
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    localStorage.setItem('praise_stats', JSON.stringify(stats));
    
    return stats;
}

        // 2. Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = () => {
            initWebSocket();
            setupNewUser();
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
            const savedName = localStorage.getItem('user_name');
            if(savedName) {
                const input = document.getElementById('userNameInput');
                if(input) input.value = savedName;
            }
            setTimeout(() => {
            updateActiveDisplay();
            }, 300);
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            loadLocalStats();
            initializeLocalStats();
            updateMainDisplay();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            document.getElementById('mainCounter').innerText = localCount;
            document.getElementById('totalPraise').innerText = totalCount;
            document.getElementById('todayPraise').innerText = todayCount;
            loadLocalData();
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´Ø®Øµ Ù†Ø´Ø· Ù…Ù† Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©
            const savedActivePerson = localStorage.getItem('active_person');
            if(savedActivePerson) {
                const person = JSON.parse(savedActivePerson);
                setActivePerson(person.id, person.name);
            }
            userId = localStorage.getItem('user_id') || generateUserId();
            localStorage.setItem('user_id', userId);
             setupEventListeners();
        };

        // 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ (Tabs ÙˆØ§Ù„ØµÙØ­Ø§Øª)
        function switchPage(pageId, title, btn) {
            console.log("Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰:", pageId);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const targetPage = document.getElementById(pageId);
            if(targetPage) targetPage.classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            document.getElementById('pageTitle').innerText = title;
            
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµÙØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø§ØªØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø¨ ÙÙˆØ±Ø§Ù‹
            if(pageId === 'communityPage') {
                loadCampaigns();
                loadPersons();
            }
        }

        function switchTab(tabId, btn) {
            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            document.getElementById(tabId).style.display = 'block';
        }
        async function sendCampaignPraise(campaignId) {
    console.log(`ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø­Ù…Ù„Ø© ${campaignId}`);
    
    // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± REST API
    try {
        const response = await fetch(`${BASE_URL}/api/v1/community/pray/${campaignId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log("âœ… ØªÙ…Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:", result);
            
            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ø¨Ø± WebSocket
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    "type": "PRAISE_CLICK",
                    "campaign_id": campaignId,
                    "amount": 1,
                    "user_id": userId,
                    "user_name": localStorage.getItem('user_name') || "Ù…Ø³ØªØ®Ø¯Ù…"
                }));
            }
            
            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateCampaignCounter(campaignId, 1);
            
            return true;
        } else {
            console.warn("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø®Ø§Ø¯Ù…");
            saveCampaignPraiseToOffline(campaignId);
            return false;
        }
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
        saveCampaignPraiseToOffline(campaignId);
        return false;
    }
}
        // 4. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ³Ø¨ÙŠØ­ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© doPraise Ù„Ø¥Ø¶Ø§ÙØ© Ø­ÙØ¸ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø´Ø®Ø§Øµ
function doPraise(event) {
    // Ù…Ù†Ø¹ Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´ ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
    if (event) {
        if (event.cancelable) event.preventDefault();
        event.stopPropagation();
    }
    if (activeCampaignId) {
        const activeCard = document.querySelector(`[data-campaign-id="${activeCampaignId}"]`);
        if (activeCard) {
            const current = parseInt(activeCard.querySelector('.current-count').innerText);
            const target = parseInt(activeCard.dataset.target);
            if (current >= target) {
                alert("ØªÙ… ØªØ­Ù‚ÙŠÙ‚ Ù‡Ø¯Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù….");
                resetToGeneralPraise();
                return;
            }
        }
    }

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹
    localCount++;
    todayCount++;
    totalCount++;
    
    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø¯ÙŠÙƒ)
    saveLocalStats(); 

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
    const mainCtr = document.getElementById('mainCounter');
    const todayCtr = document.getElementById('todayPraise');
    const totalCtr = document.getElementById('totalPraise');
    
    if(mainCtr) mainCtr.innerText = localCount;
    if(todayCtr) todayCtr.innerText = todayCount;
    if(totalCtr) totalCtr.innerText = totalCount;

    // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± (Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)
    if (activePersonId) {
        savePersonStats(activePersonId);
        if (typeof sendPersonPraise === "function") {
            sendPersonPraise(activePersonId);
        }
    } 
    else if (activeCampaignId) {
        if (typeof sendCampaignPraise === "function") {
            sendCampaignPraise(activeCampaignId);
        }
    }

    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ø­Ø³Ø§Ø³ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ
    const btn = event ? event.currentTarget : document.querySelector('.counter-btn');
    if (btn) {
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => btn.style.transform = 'scale(1)', 100);
    }

    return false;
}



// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø®Øµ
function savePersonStats(personId) {
    
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let campaignStats = JSON.parse(localStorage.getItem('campaign_stats')) || {};
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
    if (!campaignStats[personId]) {
        campaignStats[personId] = {
            count: 0,
            firstPraiseDate: new Date().toISOString(),
            lastPraiseDate: new Date().toISOString(),
            daily: {}
        };
    }
    
    // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
    campaignStats[personId].count++;
    campaignStats[personId].lastPraiseDate = new Date().toISOString();
    
    // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
    const today = new Date().toDateString();
    if (!campaignStats[personId].daily[today]) {
        campaignStats[personId].daily[today] = 0;
    }
    campaignStats[personId].daily[today]++;
    
    // Ø­ÙØ¸ ÙÙŠ localStorage
    localStorage.setItem('campaign_stats', JSON.stringify(campaignStats));
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    updatePersonDisplay(personId, campaignStats[personId].count);
    
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function updatePersonDisplay(personId, count) {
    const personElement = document.querySelector(`[data-person-id="${personId}"]`);
    if (personElement) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        const countSpan = personElement.querySelector('.person-stats span:first-child');
        if (countSpan) {
            countSpan.textContent = `Ø³Ø§Ù‡Ù…Øª Ø¨Ù€: ${count}`;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        const targetSpan = personElement.querySelector('.person-stats span:nth-child(2)');
        if (targetSpan) {
            const targetText = targetSpan.textContent;
            const target = parseInt(targetText.replace('Ø§Ù„Ù‡Ø¯Ù: ', ''));
            const progress = (count / target) * 100;
            
            const progressBar = personElement.querySelector('.progress-fill');
            if (progressBar) {
                progressBar.style.width = `${Math.min(progress, 100)}%`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
            const percentSpan = personElement.querySelector('.person-stats span:nth-child(3)');
            if (percentSpan) {
                percentSpan.textContent = `Ø§Ù„Ù†Ø³Ø¨Ø©: ${Math.min(progress, 100).toFixed(1)}%`;
            }
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø´Ø®Øµ
function sendPersonPraise(personId) {
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¯Ø¹Ù… Ø­ÙØ¸ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    console.log(`ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø´Ø®Øµ ${personId}`);
    
    // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
    saveToOfflineQueue(personId, 'person');
}

// ========== ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© loadPersons Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ==========
function loadPersons() {
    const container = document.getElementById('personsContainer');
    if (!container) return;
    
    console.log("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ù…Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡Ù…...");
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    persons = JSON.parse(localStorage.getItem('persons')) || [];
    
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    const campaignStats = JSON.parse(localStorage.getItem('campaign_stats')) || {};
    
    if (persons.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ø®Ø§Øµ Ù…Ø¶Ø§ÙØ©</h3>
                <p>Ø£Ø¶Ù Ø£Ø´Ø®Ø§ØµØ§Ù‹ Ù„ØªØ³Ø¨Ø­ Ù„Ù‡Ù… ÙˆØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ø± Ø£Ù†Øª ÙˆÙ‡Ù…</p>
                <button class="btn-action" onclick="openModal('addPersonModal')">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø´Ø®Øµ</button>
            </div>`;
        return;
    }
    
    // ÙØ±Ø² Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø­Ø³Ø¨ Ø¢Ø®Ø± ØªØ³Ø¨ÙŠØ­
    persons.sort((a, b) => {
        const statsA = campaignStats[a.id] || { lastPraiseDate: '0' };
        const statsB = campaignStats[b.id] || { lastPraiseDate: '0' };
        return new Date(statsB.lastPraiseDate) - new Date(statsA.lastPraiseDate);
    });
    
    let personsHTML = '';
    
    persons.forEach(person => {
        const personStats = campaignStats[person.id] || { count: 0 };
        const progress = person.target > 0 ? (personStats.count / person.target) * 100 : 0;
        const isActive = activePersonId === person.id;
        
        personsHTML += `
        <div class="card person-card ${isActive ? 'active-person' : ''}" 
             style="${isActive ? 'background:#f0f9f0;' : ''}"
             data-person-id="${person.id}">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <h3 class="person-name">${person.name}</h3>
                <span class="category-tag">${person.category}</span>
            </div>
            
            ${person.description ? `<p style="font-size:0.9em; color:#555; margin:5px 0;">${person.description}</p>` : ''}
            
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
            </div>
            
            <div class="person-stats">
                <span>Ø³Ø§Ù‡Ù…Øª Ø¨Ù€: <strong>${personStats.count || 0}</strong></span>
                <span>Ø§Ù„Ù‡Ø¯Ù: ${person.target}</span>
                <span>Ø§Ù„Ù†Ø³Ø¨Ø©: ${Math.min(progress, 100).toFixed(1)}%</span>
            </div>
            
            ${personStats.lastPraiseDate ? `
                <div style="margin-top:5px; font-size:0.85em; color:#666;">
                    <i class="fas fa-clock"></i> Ø¢Ø®Ø± ØªØ³Ø¨ÙŠØ­: ${formatRelativeTime(personStats.lastPraiseDate)}
                </div>
            ` : ''}
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn-pray-for" onclick="setActivePerson(${person.id}, '${escapeString(person.name)}')">
                    ${isActive ? '<i class="fas fa-check"></i> Ù†Ø´Ø·' : '<i class="fas fa-hands-praying"></i> ØªØ³Ø¨Ø­ Ù„Ù‡'}
                </button>
                <button class="btn-delete" onclick="deletePerson(${person.id})">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
            
            ${personStats.count > 0 ? `
                <div style="margin-top:10px; padding:8px; background:#f8f9fa; border-radius:8px; font-size:0.85em;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ…: ${getTodayPraisesForPerson(person.id)}</span>
                        <span>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${getWeekPraisesForPerson(person.id)}</span>
                    </div>
                </div>
            ` : ''}
        </div>`;
    });
    
    container.innerHTML = personsHTML;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø´Ø®Øµ
function getTodayPraisesForPerson(personId) {
    const campaignStats = JSON.parse(localStorage.getItem('campaign_stats')) || {};
    const personStats = campaignStats[personId];
    
    if (!personStats || !personStats.daily) return 0;
    
    const today = new Date().toDateString();
    return personStats.daily[today] || 0;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø´Ø®Øµ
function getWeekPraisesForPerson(personId) {
    const campaignStats = JSON.parse(localStorage.getItem('campaign_stats')) || {};
    const personStats = campaignStats[personId];
    
    if (!personStats || !personStats.daily) return 0;
    
    const weekStart = getWeekStartDate();
    let weekCount = 0;
    
    Object.keys(personStats.daily).forEach(date => {
        if (date >= weekStart) {
            weekCount += personStats.daily[date];
        }
    });
    
    return weekCount;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø¨ÙŠ
function formatRelativeTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
    if (diffMins < 60) return `Ù‚Ø¨Ù„ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (diffHours < 24) return `Ù‚Ø¨Ù„ ${diffHours} Ø³Ø§Ø¹Ø©`;
    if (diffDays === 1) return 'Ø£Ù…Ø³';
    if (diffDays < 7) return `Ù‚Ø¨Ù„ ${diffDays} Ø£ÙŠØ§Ù…`;
    return `Ù‚Ø¨Ù„ ${Math.floor(diffDays / 7)} Ø£Ø³Ø§Ø¨ÙŠØ¹`;
}
// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø®Ø§Ø¯Ù…
async function sendPraiseToServer(prayerId) {
    try {
        const response = await fetch(`${BASE_URL}/api/v1/community/pray/${prayerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log("ØªÙ…Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:", result);
            
            // 6. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ø¨Ø± WebSocket
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    "type": "PRAISE_CLICK",
                    "campaign_id": prayerId, // campaign_id Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ WebSocket
                    "amount": 1
                }));
            }
            
            offlineBuffer = 0;
            
            // 7. ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª
            updateCampaignStatistics(prayerId);
            
        } else {
            console.warn("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø®Ø§Ø¯Ù…");
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
            saveToOfflineQueue(prayerId);
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
        saveToOfflineQueue(prayerId);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
function updateCampaignStatistics(prayerId) {
    let campaignStats = JSON.parse(localStorage.getItem('campaign_stats')) || {};
    
    if (!campaignStats[prayerId]) {
        campaignStats[prayerId] = {
            count: 0,
            firstDate: new Date().toISOString(),
            lastDate: new Date().toISOString()
        };
    }
    
    campaignStats[prayerId].count++;
    campaignStats[prayerId].lastDate = new Date().toISOString();
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø­Ù…Ù„Ø©
    const today = new Date().toDateString();
    if (!campaignStats[prayerId].daily) {
        campaignStats[prayerId].daily = {};
    }
    
    if (!campaignStats[prayerId].daily[today]) {
        campaignStats[prayerId].daily[today] = 0;
    }
    campaignStats[prayerId].daily[today]++;
    
    localStorage.setItem('campaign_stats', JSON.stringify(campaignStats));
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    updateCampaignDisplay(prayerId, campaignStats[prayerId].count);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function updateCampaignDisplay(prayerId, count) {
    const badge = document.querySelector(`[data-prayer-id="${prayerId}"] .campaign-badge`);
    if (badge) {
        badge.textContent = `Ø³Ø§Ù‡Ù…ØªÙ Ø¨Ù€ ${count} ØªØ³Ø¨ÙŠØ­Ø©`;
        badge.style.display = 'inline-block';
    }
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ù…Ø­Ø¯Ø«Ø©)
function saveLocalStats() {
    const stats = JSON.parse(localStorage.getItem('praise_stats')) || {
        total: 0,
        today: 0,
        todayDate: new Date().toDateString(),
        week: 0,
        weekStart: getWeekStartDate(),  
        streaks: 0,
        lastPraiseDate: null,
        sessionCount: 0 // <-- Ø¥Ø¶Ø§ÙØ©
    };
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    stats.total = totalCount;
    stats.today = todayCount;
    stats.sessionCount = localCount; // <-- Ø­ÙØ¸ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©
    stats.todayDate = new Date().toDateString();
    stats.week = (stats.week || 0) + 1;
    stats.lastPraiseDate = new Date().toISOString();
    
    localStorage.setItem('praise_stats', JSON.stringify(stats));
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStatsDisplay() {
    const stats = JSON.parse(localStorage.getItem('praise_stats')) || {};
    
    document.getElementById('statTotal').textContent = stats.total || 0;
    document.getElementById('statWeek').textContent = stats.week || 0;
    document.getElementById('statPersons').textContent = persons ? persons.length : 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    const streakElement = document.getElementById('statStreak');
    if (streakElement) {
        streakElement.textContent = stats.streaks || 0;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
function saveToOfflineQueue(prayerId) {
    let offlineQueue = JSON.parse(localStorage.getItem('offline_praises')) || [];
    
    offlineQueue.push({
        prayer_id: prayerId,
        timestamp: new Date().toISOString()
    });
    
    localStorage.setItem('offline_praises', JSON.stringify(offlineQueue));
    
    // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    showOfflineNotification();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
function showOfflineNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        background: #ff9800;
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.innerHTML = `
        <i class="fas fa-wifi-slash"></i>
        ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
async function syncOfflinePraises() {
    const offlineQueue = JSON.parse(localStorage.getItem('offline_praises')) || [];
    if (offlineQueue.length === 0) return;
    
    console.log(`Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${offlineQueue.length} ØªØ³Ø¨ÙŠØ­ Ù…Ø­ÙÙˆØ¸...`);
    
    let successful = 0;
    for (const praise of offlineQueue) {
        try {
            const response = await fetch(`${BASE_URL}/api/v1/community/pray/${praise.prayer_id}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                successful++;
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± WebSocket Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        "type": "PRAISE_CLICK",
                        "campaign_id": praise.prayer_id,
                        "amount": 1
                    }));
                }
            }
        } catch (error) {
            console.error(`ÙØ´Ù„ Ù…Ø²Ø§Ù…Ù†Ø© ØªØ³Ø¨ÙŠØ­:`, error);
        }
    }
    
    // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    if (successful > 0) {
        showSyncNotification(successful);
        
        // Ø­Ø°Ù Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
        localStorage.removeItem('offline_praises');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
function showSyncNotification(count) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        background: var(--sage-green);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.innerHTML = `
        <i class="fas fa-check-circle"></i>
        ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${count} ØªØ³Ø¨ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­!
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// ÙÙŠ initWebSocketØŒ Ø£Ø¶Ù Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„:
// socket.onopen = () => {
//     console.log("Ù…ØªØµÙ„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø© Ø§Ù„Ø­ÙŠ");
    
//     // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙˆØ±Ø§Ù‹
//     syncOfflinePraises();
// };

// Ø§Ø³ØªÙ…Ø¹ Ù„Ø­Ø¯Ø« Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
window.addEventListener('online', () => {
    console.log("Ø¹Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
    syncOfflinePraises();
});
// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
async function sendPraiseToServer(prayerId, amount) {
    try {
        const response = await fetch(`${BASE_URL}/api/v1/community/pray/${prayerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log("ØªÙ…Øª Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­:", result);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ù„Ø­Ù…Ù„Ø© Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª
            updateCampaignCounter(prayerId, result.new_count);
        } else {
            console.warn("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¨ÙŠØ­");
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
            saveToOfflineQueue(prayerId, amount);
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:", error);
        saveToOfflineQueue(prayerId, amount);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function updateCampaignCounter(campaignId, newCount) {
    const card = document.querySelector(`[data-campaign-id="${campaignId}"]`);
    if (!card) return;

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const currentSpan = card.querySelector('.current-count');
    if (currentSpan) currentSpan.innerText = newCount;

    const target = parseInt(card.dataset.target) || 1;
    const progress = (newCount / target) * 100;
    
    const fill = card.querySelector('.progress-fill');
    if (fill) {
        fill.style.width = Math.min(progress, 100) + '%';
        if (progress >= 100) fill.style.background = '#27ae60';
    }

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¢Ù†
    if (progress >= 100) {
        const actionArea = card.querySelector('.action-area') || card.querySelector('.action-container');
        
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø²Ø± Ø¨Ø±Ø³Ø§Ù„Ø© "ØªÙ… ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù"
        if (actionArea && !actionArea.querySelector('.achieved-msg')) {
            actionArea.innerHTML = `
                <div class="achieved-msg" style="background:#27ae60; color:white; padding:10px; border-radius:10px; text-align:center; font-weight:bold; animation: pulse 2s infinite;">
                    âœ… ØªÙ… ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù Ø¨Ø­Ù…Ø¯ Ø§Ù„Ù„Ù‡
                </div>`;
        }

        // 3. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ù‡Ù…: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¨Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©
        if (activeCampaignId == campaignId) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ø¶Ø­Ø©
            alert(`Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ ØªÙ… ØªØ­Ù‚ÙŠÙ‚ Ù‡Ø¯Ù Ø­Ù…Ù„Ø© "${card.querySelector('.person-name').innerText}". Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø§Ù„Ø¢Ù† Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù….`);
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…
            resetToGeneralPraise();
        }
    }
}

function resetToGeneralPraise() {
    // Ø¥ÙØ±Ø§Øº Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    activeCampaignId = null;
    activePersonId = null;
    
    // Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø­ØªÙ‰ Ù„Ø§ ØªØ¹ÙˆØ¯ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
    localStorage.removeItem('active_campaign');
    localStorage.removeItem('active_person');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­ (Ù…Ø«Ù„Ø§Ù‹: ØªØºÙŠÙŠØ± "Ø£Ù†Øª ØªØ³Ø¨Ø­ Ù„Ù€...")
    const activeText = document.getElementById('activeTargetText'); // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù€ ID ÙÙŠ Ø§Ù„Ù€ HTML Ù„Ø¯ÙŠÙƒ
    if (activeText) {
        activeText.innerText = "ØªØ³Ø¨ÙŠØ­ Ø¹Ø§Ù…";
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ ÙˆØ§Ø¬Ù‡Ø§Øª Ø£Ø®Ø±Ù‰ Ù…Ø±ØªØ¨Ø·Ø©
    updateActiveDisplay(); 
    
    console.log("ØªÙ…Øª Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù… Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø©.");
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„
function saveToOfflineQueue(prayerId, amount) {
    // Ø§Ø­ÙØ¸ ÙÙŠ localStorage Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
    let offlineQueue = JSON.parse(localStorage.getItem('offline_praises')) || [];
    offlineQueue.push({
        prayer_id: prayerId,
        amount: amount,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('offline_praises', JSON.stringify(offlineQueue));
    console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹");
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
async function syncOfflinePraises() {
    const offlineQueue = JSON.parse(localStorage.getItem('offline_praises')) || [];
    if (offlineQueue.length === 0) return;
    
    console.log(`Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${offlineQueue.length} ØªØ³Ø¨ÙŠØ­ Ù…Ø­ÙÙˆØ¸...`);
    
    for (const praise of offlineQueue) {
        try {
            await fetch(`${BASE_URL}/api/v1/community/pray/${praise.prayer_id}`, {
                method: 'POST'
            });
            console.log(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ØªØ³Ø¨ÙŠØ­ Ù„Ù€ ${praise.prayer_id}`);
        } catch (error) {
            console.error(`ÙØ´Ù„ Ù…Ø²Ø§Ù…Ù†Ø© ØªØ³Ø¨ÙŠØ­ Ù„Ù€ ${praise.prayer_id}:`, error);
            break; // ØªÙˆÙ‚Ù Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
        }
    }
    
    // Ø§Ø­Ø°Ù Ø§Ù„ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
    localStorage.removeItem('offline_praises');
}
        // 5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ
        // let persons = JSON.parse(localStorage.getItem('persons')) || [];

        // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© loadPersons Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
function loadPersons() {
        persons = JSON.parse(localStorage.getItem('persons')) || [];
    const container = document.getElementById('personsContainer');
    if (!container) return;
    
    console.log("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ...");
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ù…Ù† localStorage
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ø´Ø®Ø§Øµ
    if (persons.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ø®Ø§Øµ Ù…Ø¶Ø§ÙØ©</h3>
                <p>Ø£Ø¶Ù Ø£Ø´Ø®Ø§ØµØ§Ù‹ Ù„ØªØ³Ø¨Ø­ Ù„Ù‡Ù… ÙˆØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ø± Ø£Ù†Øª ÙˆÙ‡Ù…</p>
                <button class="btn-action" onclick="openModal('addPersonModal')">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø´Ø®Øµ</button>
            </div>`;
        return;
    }
    
    // ÙØ±Ø² Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    persons.sort((a, b) => {
        const dateA = new Date(a.created || a.timestamp || 0);
        const dateB = new Date(b.created || b.timestamp || 0);
        return dateB - dateA;
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø£Ø´Ø®Ø§Øµ
    let personsHTML = '';
    
    persons.forEach(person => {
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ
        const campaignStats = JSON.parse(localStorage.getItem('campaign_stats')) || {};
        const personStats = campaignStats[person.id] || { count: 0 };
        
        const progress = personStats.count ? (personStats.count / person.target) * 100 : 0;
        const isActive = activePersonId === person.id;
        
        personsHTML += `
        <div class="card person-card ${isActive ? 'active-person' : ''}" 
             style="${isActive ? 'background:#f0f9f0;' : ''}"
             data-person-id="${person.id}">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <h3 class="person-name">${person.name}</h3>
                <span class="category-tag">${person.category}</span>
            </div>
            
            ${person.description ? `<p style="font-size:0.9em; color:#555; margin:5px 0;">${person.description}</p>` : ''}
            
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            
            <div class="person-stats">
                <span>Ø³Ø§Ù‡Ù…Øª Ø¨Ù€: ${personStats.count || 0}</span>
                <span>Ø§Ù„Ù‡Ø¯Ù: ${person.target}</span>
                <span>Ø§Ù„Ù†Ø³Ø¨Ø©: ${Math.min(progress, 100).toFixed(1)}%</span>
            </div>
            
            <div style="margin-top:5px; font-size:0.85em; color:#666;">
                <i class="fas fa-calendar"></i> Ø£Ø¶ÙŠÙ ÙÙŠ: ${formatDate(person.created || person.timestamp)}
            </div>
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn-pray-for" onclick="setActivePerson(${person.id}, '${escapeString(person.name)}')">
                    ${isActive ? '<i class="fas fa-check"></i> Ù†Ø´Ø·' : '<i class="fas fa-hands-praying"></i> ØªØ³Ø¨Ø­ Ù„Ù‡'}
                </button>
                <button class="btn-delete" onclick="deletePerson(${person.id})">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
        </div>`;
    });
    
    container.innerHTML = personsHTML;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(dateString) {
    if (!dateString) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-SA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    } catch (e) {
        return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ù†ØµÙˆØµ
function escapeString(str) {
    return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© setActivePerson
function setActivePerson(id, name) {
    activePersonId = id;
    activeCampaignId = null; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    
    // Ø­ÙØ¸ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
    localStorage.setItem('active_person', JSON.stringify({id, name}));
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø¯Ø¬
    const badge = document.getElementById('activePersonBadge');
    if (badge) {
        badge.style.display = 'block';
        document.getElementById('activePersonName').innerText = name;
    }
    
    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­
    const counterBtn = document.querySelector('.counter-btn');
    if (counterBtn) {
        counterBtn.style.borderColor = 'var(--light-blue)';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    loadPersons();
    
    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø§ØªØŒ Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­
    if (document.getElementById('communityPage').classList.contains('active')) {
        switchPage('praisePage', `ØªØ³Ø¨ÙŠØ­ Ù„Ù€: ${name}`, document.getElementById('praiseBtn'));
    }
    
    // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    showTemporaryAlert(`Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ Ù„Ù€: ${name}`, 'success');
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¤Ù‚Øª
function showTemporaryAlert(message, type = 'info') {
    const colors = {
        success: 'var(--sage-green)',
        info: 'var(--light-blue)',
        warning: 'orange',
        error: '#e74c3c'
    };
    
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.5s';
        setTimeout(() => alertDiv.remove(), 500);
    }, 3000);
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…ÙŠØ´Ù† Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(style);

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© switchTab Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
function switchTab(tabId, btn) {
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.style.display = 'block';
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø´Ø®Ø§ØµØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡Ù…
        if (tabId === 'personsTab') {
            setTimeout(() => {
                loadPersons();
            }, 100); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø£ÙˆÙ„Ø§Ù‹
        }
    }
}

        function addNewPerson() {
            const name = document.getElementById('personName').value;
            const desc = document.getElementById('personDesc').value;
            const category = document.getElementById('personCategory').value;
            const target = parseInt(document.getElementById('personTarget').value) || 1000;
            
            if (!name) {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ");
                return;
            }
            
            const newPerson = {
                id: Date.now(),
                name: name,
                description: desc,
                category: category,
                target: target,
                current: 0,
                created: new Date().toISOString(),
                userId: userId
            };
            
            persons.push(newPerson);
            localStorage.setItem('persons', JSON.stringify(persons));
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            history.back();
            loadPersons();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£Ø´Ø®Ø§ØµØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„ÙŠÙ‡Ø§
            if (document.getElementById('communityPage').classList.contains('active')) {
                switchTab('personsTab', document.querySelector('#personsTab').previousElementSibling);
            }
            
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${name} Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ³Ø¨ÙŠØ­ Ù„Ù‡.`);
            
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('personName').value = '';
            document.getElementById('personDesc').value = '';
        }

        function setActivePerson(id, name) {
            activePersonId = id;
            activeCampaignId = null; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            
            // Ø­ÙØ¸ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
            localStorage.setItem('active_person', JSON.stringify({id, name}));
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø¯Ø¬
            const badge = document.getElementById('activePersonBadge');
            badge.style.display = 'block';
            document.getElementById('activePersonName').innerText = name;
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­
            document.querySelector('.counter-btn').style.borderColor = 'var(--light-blue)';
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
            loadPersons();
            
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­
            switchPage('praisePage', `ØªØ³Ø¨ÙŠØ­ Ù„Ù€: ${name}`, document.getElementById('praiseBtn'));
            
            alert(`Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ Ù„Ù€: ${name}. ÙƒÙ„ Ù†Ù‚Ø±Ø© Ø³ØªÙØ¶Ø§Ù Ù„Ù‡ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡.`);
        }

        function clearActivePerson() {
            activePersonId = null;
            localStorage.removeItem('active_person');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬
            document.getElementById('activePersonBadge').style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­
            document.querySelector('.counter-btn').style.borderColor = 'var(--sage-green)';
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
            loadPersons();
        }

        function deletePerson(id) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ")) return;
            
            persons = persons.filter(p => p.id !== id);
            localStorage.setItem('persons', JSON.stringify(persons));
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ù‡Ùˆ Ø§Ù„Ù†Ø´Ø·ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·
            if (activePersonId === id) {
                clearActivePerson();
            }
            
            loadPersons();
        }

        // 6. Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
        async function loadCampaigns() {
    const container = document.getElementById('campaignsContainer');
    if (!container) return;

    try {
        const response = await fetch(`${BASE_URL}/api/v1/community/campaigns`);
        if (!response.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ù…Ù„Ø§Øª');
        
        const campaigns = await response.json();
        
        if (campaigns.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            return;
        }

        let campaignsHTML = '';
        campaigns.forEach(campaign => {
            const current = campaign.current_count || 0;
            const target = campaign.target_count || 1; // ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±
            const progress = (current / target) * 100;
            const isActive = activeCampaignId === campaign.id;

            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„Ø²Ø±
            let actionAreaHTML = '';
            if (progress >= 100) {
                // Ø­Ø§Ù„Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù‡Ø¯Ù
                actionAreaHTML = `
                    <div class="target-achieved-msg" style="background: #27ae60; color: white; padding: 12px; border-radius: 10px; text-align: center; margin-top: 10px; font-weight: bold; animation: fadeIn 0.5s;">
                        <i class="fas fa-check-circle"></i> ØªÙ… ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù Ø¨Ø­Ù…Ø¯ Ø§Ù„Ù„Ù‡
                    </div>`;
            } else {
                // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ù„Ø§ ØªØ²Ø§Ù„ Ù†Ø´Ø·Ø©
                actionAreaHTML = `
                    <button class="btn-contribute" onclick="startContributing(${campaign.id}, '${escapeString(campaign.title)}')" 
                            style="${isActive ? 'background:var(--sage-green); border:2px solid white;' : ''}">
                        ${isActive ? '<i class="fas fa-check"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø¢Ù†' : 'Ø³Ø§Ù‡Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©'}
                    </button>`;
            }

            campaignsHTML += `
                <div class="card  campaign-card" data-campaign-id="${campaign.id}" data-target="${target}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 class="person-name">${campaign.title}</h3>
                        <span class="category-tag">${campaign.creator_name}</span>
                    </div>
                    <p style="font-size:0.9em; color:#666; margin:8px 0;">${campaign.description || ''}</p>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(progress, 100)}%; background: ${progress >= 100 ? '#27ae60' : 'var(--sage-green)'};"></div>
                    </div>
                    
                    <div class="person-stats">
                        <span>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong class="current-count">${current}</strong></span>
                        <span>Ø§Ù„Ù‡Ø¯Ù: ${target}</span>
                        <span class="percent-text">${progress >= 100 ? 'Ù…ÙƒØªÙ…Ù„' : progress.toFixed(1) + '%'}</span>
                    </div>

                    <div class="action-container">
                        ${actionAreaHTML}
                    </div>
                </div>`;
        });

        container.innerHTML = campaignsHTML;
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª:", error);
        container.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
    }
}

        // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© startContributing Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
function startContributing(campaignId, campaignTitle) {
    console.log(`ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© ÙÙŠ Ø§Ù„Ø­Ù…Ù„Ø© ${campaignId}: ${campaignTitle}`);
    
    // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (activePersonId) {
        clearActivePerson();
    }
    
    // 2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    activeCampaignId = campaignId;
    
    // 3. Ø­ÙØ¸ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    localStorage.setItem('active_campaign', JSON.stringify({
        id: campaignId,
        title: campaignTitle
    }));
    
    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateActiveDisplay();
    
    // 5. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­
    switchPage('praisePage', `Ù…Ø³Ø§Ù‡Ù…Ø© ÙÙŠ: ${campaignTitle}`, document.getElementById('praiseBtn'));
    
    // 6. Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    showTemporaryAlert(`Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ Ù„Ù€: ${campaignTitle}`, 'info');
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
function clearActivePerson() {
    console.log(`ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø· ${activePersonId}`);
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† localStorage
    localStorage.removeItem('active_person');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±
    activePersonId = null;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
    updateActivePersonBadge();
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ³Ø¨ÙŠØ­
    const counterBtn = document.querySelector('.counter-btn');
    if (counterBtn) {
        counterBtn.style.borderColor = 'var(--sage-green)';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    loadPersons();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·
function updateActiveDisplay() {
    const badge = document.getElementById('activePersonBadge');
    const counterBtn = document.querySelector('.counter-btn');
    
    if (activePersonId) {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
        const person = persons.find(p => p.id === activePersonId);
        if (person && badge) {
            badge.style.display = 'block';
            document.getElementById('activePersonName').innerText = person.name;
        }
        if (counterBtn) {
            counterBtn.style.borderColor = 'var(--light-blue)';
        }
    } else if (activeCampaignId) {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
        if (badge) {
            badge.style.display = 'none';
        }
        if (counterBtn) {
            counterBtn.style.borderColor = 'var(--sage-green)';
        }
    } else {
        // Ù„Ø§ Ø´ÙŠØ¡ Ù†Ø´Ø·
        if (badge) {
            badge.style.display = 'none';
        }
        if (counterBtn) {
            counterBtn.style.borderColor = 'var(--sage-green)';
        }
    }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© setActivePerson Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
function setActivePerson(id, name) {
    console.log(`ğŸ‘¤ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·: ${name} (${id})`);
    
    // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (activeCampaignId) {
        localStorage.removeItem('active_campaign');
        activeCampaignId = null;
    }
    
    // 2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
    activePersonId = id;
    
    // 3. Ø­ÙØ¸ ÙÙŠ localStorage
    localStorage.setItem('active_person', JSON.stringify({id, name}));
    
    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateActiveDisplay();
    
    // 5. ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ø®Ø§Øµ
    loadPersons();
    
    // 6. Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø§ØªØŒ Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¨ÙŠØ­
    if (document.getElementById('communityPage').classList.contains('active')) {
        switchPage('praisePage', `ØªØ³Ø¨ÙŠØ­ Ù„Ù€: ${name}`, document.getElementById('praiseBtn'));
    }
    
    // 7. Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    showTemporaryAlert(`Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ Ù„Ù€: ${name}`, 'success');
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…
function switchToGeneralPraise() {
    console.log("ğŸ”„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù…");
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù†Ø´Ø·
    if (activePersonId) {
        clearActivePerson();
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    if (activeCampaignId) {
        localStorage.removeItem('active_campaign');
        activeCampaignId = null;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateActiveDisplay();
    
    // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    showTemporaryAlert('Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³Ø¨Ø­ ØªØ³Ø¨ÙŠØ­Ø§Ù‹ Ø¹Ø§Ù…Ø§Ù‹', 'info');
}

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¨ÙŠØ­ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
// ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ HTML:
/*
<div id="activePersonBadge" class="active-person-badge" style="display:none;">
    <i class="fas fa-user"></i> Ø£Ù†Øª ØªØ³Ø¨Ø­ Ù„Ù€: <span id="activePersonName"></span>
    <button onclick="switchToGeneralPraise()" style="margin-right:10px; background:none; border:none; color:#666; cursor:pointer;">
        <i class="fas fa-times"></i>
    </button>
</div>
*/

// Ø£Ùˆ Ø¥Ø¶Ø§ÙØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
function enhanceActiveBadge() {
    const badge = document.getElementById('activePersonBadge');
    if (badge && !badge.querySelector('.close-btn')) {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.style.cssText = `
            margin-right: 10px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9em;
        `;
        closeBtn.onclick = switchToGeneralPraise;
        
        badge.insertBefore(closeBtn, badge.firstChild);
    }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ enhanceActiveBadge ÙÙŠ window.onload
window.onload = async () => {
    // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    initWebSocket();
    // setupNewUser();

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (LocalStorage)
    // Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© totalCount Ùˆ todayCount
    const stats = await initializeLocalStats(); 
    
    // 3. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø©
    document.getElementById('mainCounter').innerText = localCount || 0;
    document.getElementById('totalPraise').innerText = totalCount || 0;
    document.getElementById('todayPraise').innerText = todayCount || 0;

    // 4. ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø£Ø´Ø®Ø§ØµØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©)
    const savedName = localStorage.getItem('user_name');
    if(savedName) {
        const input = document.getElementById('userNameInput');
        if(input) input.value = savedName;
    }
    
    loadLocalData();
    updateActiveDisplay();
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´Ø®Øµ Ù†Ø´Ø· Ù…Ø­ÙÙˆØ¸
    const savedActivePerson = localStorage.getItem('active_person');
    if(savedActivePerson) {
        const person = JSON.parse(savedActivePerson);
        setActivePerson(person.id, person.name);
    }
};

        // 7. Ù†Ø¸Ø§Ù… WebSocket
        function initWebSocket() {
    try {
        socket = new WebSocket(`${WS_URL}/ws/help`);

        socket.onopen = () => {
            console.log("Ù…ØªØµÙ„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø© Ø§Ù„Ø­ÙŠ");
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©:", data);
            
            if(data.type === "HELP_REQUEST") {
                const currentUserName = localStorage.getItem('user_name');
                if(data.username !== currentUserName) {
                    if(confirm(`Ø£Ø®ÙˆÙ†Ø§ ${data.username} ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ${data.count} ØªØ³Ø¨ÙŠØ­Ø©. Ù‡Ù„ ØªØ¹ÙŠÙ†Ù‡ØŸ`)) {
                        alert("Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹ØŒ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ùƒ.");
                    }
                }
            }
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª
            if(data.type === "UPDATE_COUNT") {
                console.log("ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ù…Ù„Ø©:", data.campaign_id, "Ø¨Ù…Ù‚Ø¯Ø§Ø±:", data.added_amount);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                updateCampaignCounter(data.campaign_id, data.added_amount);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø© Ù‡ÙŠ Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø®ØµÙŠ
                if (data.campaign_id == activeCampaignId) {
                    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§
                }
            }
        };

        socket.onclose = () => {
            console.log("Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ WSØŒ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù...");
            setTimeout(initWebSocket, 3000);
        };
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ WebSocket:", e);
    }
}

        function syncOfflineBuffer() {
            if (offlineBuffer > 0 && socket.readyState === WebSocket.OPEN) {
                let message = {};
                
                if (activePersonId) {
                    message = {
                        "type": "PERSON_PRAISE",
                        "person_id": activePersonId,
                        "amount": offlineBuffer
                    };
                } else if (activeCampaignId) {
                    message = {
                        "type": "CAMPAIGN_PRAISE",
                        "campaign_id": activeCampaignId,
                        "amount": offlineBuffer
                    };
                } else {
                    message = {
                        "type": "GENERAL_PRAISE",
                        "amount": offlineBuffer
                    };
                }
                
                socket.send(JSON.stringify(message));
                offlineBuffer = 0;
                console.log("ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø®Ø²Ù† Ø¨Ù†Ø¬Ø§Ø­");
            }
        }

        // 8. Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø©
        async function broadcastHelp() {
            const title = document.getElementById('helpTitle').value;
            const desc = document.getElementById('helpDesc').value;
            const target = document.getElementById('helpTarget').value;
            const name = localStorage.getItem('user_name') || "ÙØ§Ø¹Ù„ Ø®ÙŠØ±";

            if (!title || !target) {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨");
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/v1/community/request-duaa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: desc,
                        target_count: parseInt(target),
                        creator_name: name,
                        category: "Ø¹Ø§Ù…"
                    })
                });

                if (response.ok) {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: "HELP_REQUEST",
                            username: name,
                            count: target,
                            title: title
                        }));
                    }
                    
                    alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
                    history.back();
                    loadCampaigns();
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
                }
            } catch (e) {
                console.error("Error sending help request:", e);
                alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        }

        // 9. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        function loadLocalStats() {
            const stats = JSON.parse(localStorage.getItem('praise_stats')) || {
                total: 0,
                today: 0,
                todayDate: new Date().toDateString(),
                week: 0,
                weekStart: getWeekStartDate()
            };
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ØªØºÙŠØ±ØŒ Ø£Ø¹Ø¯ Ø¶Ø¨Ø· ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„ÙŠÙˆÙ…
            if (stats.todayDate !== new Date().toDateString()) {
                stats.today = 0;
                stats.todayDate = new Date().toDateString();
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ØªØºÙŠØ±ØŒ Ø£Ø¹Ø¯ Ø¶Ø¨Ø· ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            if (stats.weekStart !== getWeekStartDate()) {
                stats.week = 0;
                stats.weekStart = getWeekStartDate();
            }
            
            totalCount = stats.total;
            todayCount = stats.today;
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('statTotal').innerText = stats.total;
            document.getElementById('statWeek').innerText = stats.week;
            document.getElementById('statPersons').innerText = persons.length;
            
            // Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            localStorage.setItem('praise_stats', JSON.stringify(stats));
        }

        function saveLocalStats() {
            const stats = JSON.parse(localStorage.getItem('praise_stats')) || {
                total: 0,
                today: 0,
                todayDate: new Date().toDateString(),
                week: 0,
                weekStart: getWeekStartDate()
            };
            
            stats.total = totalCount;
            stats.today = todayCount;
            stats.todayDate = new Date().toDateString();
            stats.week = (stats.week || 0) + 1; // Ø²ÙŠØ§Ø¯Ø© ØªØ³Ø¨ÙŠØ­Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            
            localStorage.setItem('praise_stats', JSON.stringify(stats));
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('statTotal').innerText = stats.total;
            document.getElementById('statWeek').innerText = stats.week;
            document.getElementById('statPersons').innerText = persons.length;
        }

        function getWeekStartDate() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Ø§Ù„Ø¥Ø«Ù†ÙŠÙ† Ù‡Ùˆ Ø£ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            return new Date(now.setDate(diff)).toDateString();
        }

        // 10. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†ÙˆØ§ÙØ°
        function saveUserName() {
            const input = document.getElementById('userNameInput');
            if(input && input.value.trim() !== "") {
                localStorage.setItem('user_name', input.value);
                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­");
                history.back();
            } else {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");
            }
        }

        function clearAllData() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ Ù‡Ø°Ø§ ÙŠØ´Ù…Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø¶Ø§ÙØ©.")) {
                localStorage.clear();
                persons = [];
                localCount = 0;
                todayCount = 0;
                totalCount = 0;
                activePersonId = null;
                activeCampaignId = null;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                location.reload();
            }
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            if(modal) {
                modal.classList.add('active');
                history.pushState({modalOpen: id}, "");
            }
        }

        window.onpopstate = () => {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        };

        function closeOnOverlay(e) {
            if(e.target.classList.contains('modal')) {
                history.back();
            }
        }

        // 11. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§ØªØµØ§Ù„/Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        window.addEventListener('online', () => {
            console.log("Ø¹Ø§Ø¯Øª Ø§Ù„Ø´Ø¨ÙƒØ©! Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Ù‚Ø±Ø§Øª...");
            initWebSocket(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒÙŠØª
            syncOfflinePraises();
        });

        window.addEventListener('offline', () => {
            console.log("ÙÙ‚Ø¯Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª... Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹.");
        });
    </script>
</body>

</html>



